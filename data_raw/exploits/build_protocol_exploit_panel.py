from pathlib import Path
import pandas as pd

BASE = Path("data_raw")
EVENTS = BASE / "exploits" / "exploit_events_defillama.csv"
OUT = BASE / "exploits" / "protocol_exploit_panel.csv"

def main():
    if not EVENTS.exists():
        raise SystemExit(f"Missing: {EVENTS}. Run build_exploit_master_from_defillama.py first.")

    df = pd.read_csv(EVENTS)

    # only mapped protocols
    df = df[df["in_llama"] == 1].copy()
    if df.empty:
        raise SystemExit("No mapped exploit events (in_llama==1). Check mapping.")

    df["loss_usd"] = pd.to_numeric(df["loss_usd"], errors="coerce")
    df["exploit_date"] = pd.to_datetime(df["exploit_date"], errors="coerce", utc=True)

    g = df.groupby("slug", as_index=False).agg(
        exploited=("slug", "size"),
        num_hacks=("slug", "size"),
        hack_loss_usd=("loss_usd", "sum"),
        hack_loss_usd_known=("loss_usd", lambda x: x.dropna().sum()),
        any_loss_reported=("loss_usd", lambda x: int(x.notna().any())),
        first_exploit_ts=("exploit_date", "min"),
        last_exploit_ts=("exploit_date", "max"),
    )
    g["exploited"] = (g["num_hacks"] > 0).astype(int)

    OUT.parent.mkdir(parents=True, exist_ok=True)
    g.to_csv(OUT, index=False)

    print(f"âœ… Wrote: {OUT} | rows={len(g)}")
    print("exploited=1:", int(g["exploited"].sum()))

if __name__ == "__main__":
    main()