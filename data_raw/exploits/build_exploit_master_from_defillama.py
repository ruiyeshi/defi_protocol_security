from pathlib import Path
import pandas as pd
import numpy as np
import re

BASE = Path("data_raw")
OUTD = BASE / "exploits"
OUTD.mkdir(parents=True, exist_ok=True)

# Inputs (yours are currently in contracts/)
HACKS_IN = BASE / "contracts" / "defillama_hacks_processed.csv"
LLAMA_IN = BASE / "llama_protocols.csv"  # must exist in your repo
OUT = OUTD / "exploit_events_defillama.csv"

def norm_name(s: str) -> str:
    s = (s or "").strip().lower()
    s = re.sub(r"[^a-z0-9]+", " ", s).strip()
    return s

def pick_slug(row, llama_by_id, llama_by_name):
    # 1) Prefer defillamaId mapping if available
    did = row.get("defillamaId")
    if pd.notna(did):
        try:
            did_int = int(float(did))
            if did_int in llama_by_id:
                return llama_by_id[did_int]
        except Exception:
            pass

    # 2) Parent protocol id sometimes exists
    pid = row.get("parentProtocolId")
    if pd.notna(pid):
        try:
            pid_int = int(float(pid))
            if pid_int in llama_by_id:
                return llama_by_id[pid_int]
        except Exception:
            pass

    # 3) Fallback name match
    n = norm_name(str(row.get("name", "")))
    return llama_by_name.get(n)

def main():
    if not HACKS_IN.exists():
        raise SystemExit(f"Missing: {HACKS_IN}")
    if not LLAMA_IN.exists():
        raise SystemExit(f"Missing: {LLAMA_IN} (needed for slug mapping)")

    # Read hacks correctly (skip junk first line)
    hacks = pd.read_csv(HACKS_IN, skiprows=1)

    # Read llama protocol list
    llama = pd.read_csv(LLAMA_IN)

    # Try to build id -> slug mapping if llama file has an id column
    # (Your llama file may have 'id' or 'defillamaId' depending on how you built it.)
    id_col = None
    for c in ["defillamaId", "id", "protocol_id", "parentProtocolId"]:
        if c in llama.columns:
            id_col = c
            break

    llama_by_id = {}
    if id_col is not None:
        for _, r in llama.dropna(subset=[id_col, "slug"]).iterrows():
            try:
                llama_by_id[int(float(r[id_col]))] = r["slug"]
            except Exception:
                continue

    llama_by_name = {norm_name(n): s for n, s in zip(llama["name"].astype(str), llama["slug"].astype(str))}

    # Parse date + loss
    hacks["exploit_date"] = pd.to_datetime(hacks["exploit_date"], errors="coerce", utc=True)
    hacks["loss_usd"] = pd.to_numeric(hacks["loss_usd"], errors="coerce")

    # Map to llama slugs
    hacks["slug"] = hacks.apply(lambda r: pick_slug(r, llama_by_id, llama_by_name), axis=1)
    hacks["in_llama"] = hacks["slug"].notna().astype(int)

    # Clean output schema
    out = hacks.rename(columns={
        "name": "protocol_name_raw",
        "classification": "exploit_classification",
        "technique": "exploit_technique",
        "source_url": "evidence_url",
        "chain": "chain_exploit"
    })[
        ["protocol_name_raw","slug","in_llama","exploit_date","loss_usd",
         "exploit_classification","exploit_technique","chain_exploit",
         "bridgeHack","targetType","returnedFunds","defillamaId","parentProtocolId","evidence_url"]
    ].copy()

    out.to_csv(OUT, index=False)

    print(f"âœ… Wrote: {OUT} | rows={len(out)}")
    print("Mapped-to-llama rate:", round(out["in_llama"].mean(), 4))
    print("Unique slugs mapped:", out.loc[out["in_llama"]==1, "slug"].nunique())
    print("Top unmapped names:")
    print(out.loc[out["in_llama"]==0, "protocol_name_raw"].value_counts().head(15).to_string())

if __name__ == "__main__":
    main()