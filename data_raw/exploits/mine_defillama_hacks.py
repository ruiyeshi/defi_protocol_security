from pathlib import Path
import json
import pandas as pd
import requests

BASE = Path("data_raw")
OUT_RAW = BASE / "exploits_raw"
OUT_RAW.mkdir(parents=True, exist_ok=True)

OUT_CSV = OUT_RAW / "defillama_hacks.csv"
OUT_JSON = OUT_RAW / "defillama_hacks.json"

# DeFiLlama provides a hacks endpoint; if it changes, you only update this URL.
URL = "https://api.llama.fi/hacks"

def main():
    r = requests.get(URL, timeout=60)
    r.raise_for_status()
    data = r.json()

    # Save JSON backup
    OUT_JSON.write_text(json.dumps(data, ensure_ascii=False, indent=2), encoding="utf-8")

    # Normalize to dataframe
    # The endpoint usually returns a list of hack objects.
    if isinstance(data, dict) and "hacks" in data:
        rows = data["hacks"]
    else:
        rows = data

    df = pd.json_normalize(rows)

    # Save raw CSV
    df.to_csv(OUT_CSV, index=False)
    print(f"âœ… Wrote: {OUT_CSV} | rows={len(df)} | cols={len(df.columns)}")
    print("Top columns:", df.columns.tolist()[:25])

if __name__ == "__main__":
    main()