from pathlib import Path
import pandas as pd

BASE = Path("data_raw")
AUD = BASE / "audits" / "protocol_security_review_master.csv"
EX = BASE / "exploits" / "protocol_exploit_panel.csv"
OUT = BASE / "panel" / "protocol_panel_v1.csv"

def main():
    if not AUD.exists():
        raise SystemExit(f"Missing: {AUD}")
    if not EX.exists():
        raise SystemExit(f"Missing: {EX}. Run build_protocol_exploit_panel.py first.")

    OUT.parent.mkdir(parents=True, exist_ok=True)

    a = pd.read_csv(AUD)
    e = pd.read_csv(EX)

    out = a.merge(e, on="slug", how="left")

    # fill no-exploit protocols
    for c in ["num_hacks","hack_loss_usd","hack_loss_usd_known","any_loss_reported","exploited"]:
        if c in out.columns:
            out[c] = out[c].fillna(0)

    out.to_csv(OUT, index=False)
    print(f"âœ… Wrote: {OUT} | rows={len(out)}")
    print("exploited=1:", int(out["exploited"].sum()) if "exploited" in out.columns else "n/a")

if __name__ == "__main__":
    main()