import pandas as pd

print("ðŸ”— Merging verified contracts with exploit metadata...")

verified_path = "data_raw/contracts/verified_contracts.csv"
exploits_path = "data_raw/contracts/exploit_metadata_final.csv"

df_verified = pd.read_csv(verified_path)
df_exploits = pd.read_csv(exploits_path)

# Normalize protocol names for fuzzy matching
df_verified["protocol_name_norm"] = df_verified["protocol_name"].str.lower().str.strip()
df_exploits["protocol_name_norm"] = df_exploits["protocol_name"].str.lower().str.strip()

# Merge
df_merged = df_verified.merge(
    df_exploits[["protocol_name_norm", "date", "loss_usd", "cause"]],
    on="protocol_name_norm",
    how="left"
)

# Label exploited / clean
df_merged["exploit_status"] = df_merged["date"].notna().astype(int)

output_path = "data_raw/contracts/defi_security_master.csv"
df_merged.to_csv(output_path, index=False)

print(f"âœ… Merged dataset saved to {output_path}")
print(df_merged[["protocol_name", "exploit_status", "loss_usd", "cause"]].head(10))