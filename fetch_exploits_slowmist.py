import requests
import pandas as pd
import urllib3

# disable SSL warnings safely
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

print("🌐 Fetching SlowMist security incidents list...")

url = "https://api.slowmist.io/v1/vuln"

try:
    r = requests.get(url, timeout=15, verify=False)  # 🔧 added verify=False
    r.raise_for_status()
    data = r.json()
except Exception as e:
    print(f"❌ Error accessing {url}: {e}")
    exit()

records = []
if "data" in data and isinstance(data["data"], list):
    for item in data["data"]:
        records.append({
            "source": "SlowMist",
            "title": item.get("title", "N/A"),
            "link": item.get("url", "N/A"),
            "category": item.get("category", "N/A"),
            "publish_time": item.get("publish_time", "N/A"),
            "project": item.get("project_name", "N/A"),
            "loss_usd": item.get("loss_usd", "N/A")
        })
else:
    print("⚠️ No valid incident data found in API response.")
    exit()

df = pd.DataFrame(records)
df.to_csv("data_raw/contracts/exploit_metadata_slowmist.csv", index=False)

print(f"✅ Saved {len(records)} SlowMist incidents to data_raw/contracts/exploit_metadata_slowmist.csv")