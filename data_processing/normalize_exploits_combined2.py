import pandas as pd
import json
from pathlib import Path

input_path = Path("data_raw/exploits_raw/exploits_combined.json")
output_path = Path("data_processed/exploits_normalized.csv")

df = pd.read_json(input_path)

# normalize key fields
df["date"] = pd.to_datetime(df["date"], errors="coerce")
df["amount_usd"] = pd.to_numeric(df["amount"], errors="coerce")
df["source"] = df["source"].str.strip()
df["title"] = df["title"].str.replace(r"\s+", " ", regex=True)

# drop duplicates
df = df.drop_duplicates(subset=["title", "url"])

# export
output_path.parent.mkdir(parents=True, exist_ok=True)
df.to_csv(output_path, index=False)
print(f"âœ… Normalized dataset saved to {output_path}")
print(df.sample(5))